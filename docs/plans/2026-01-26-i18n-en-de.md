# EN/DE i18n with Sanity Document Internationalization Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add English/German locale routing and serve Sanity content by locale using document-level translations so Content Agent can translate in Studio. German is the default/fallback language, and when locale is missing/invalid the UI shows a clear translate icon button.

**Architecture:** Next.js App Router uses `/[locale]` routes with middleware that redirects to a supported locale (default `de`) and uses `Accept-Language` for first-visit detection. Sanity uses `@sanity/document-internationalization` for document-level translations. All GROQ queries filter by `language` and use locale params. A small UI banner/button appears when locale is inferred or invalid to let users switch to English.

**Tech Stack:** Next.js 16 App Router, next-sanity, Sanity Studio v3, @sanity/document-internationalization, Clerk middleware, TypeScript.

---

### Task 0: Prepare isolated worktree (skip if already done)

**Files:**
- None

**Step 1: Verify no worktree exists**

Run: `git worktree list`
Expected: No worktree for this feature name.

**Step 2: Create worktree using @superpowers:using-git-worktrees**

Run: follow the worktree skill to create a new worktree directory for i18n.

**Step 3: Verify clean state**

Run: `git status -sb`
Expected: clean status on the new worktree.

**Step 4: Commit**

Skip (no code changes).

---

### Task 1: Add locale config and App Router segment

**Files:**
- Create: `lib/i18n.ts`
- Move: `app/(portfolio)/layout.tsx` -> `app/(portfolio)/[locale]/layout.tsx`
- Move: `app/(portfolio)/page.tsx` -> `app/(portfolio)/[locale]/page.tsx`
- Create: `tests/i18n.test.ts`

**Step 1: Write the failing test**

```ts
import assert from "node:assert/strict";
import test from "node:test";
import { defaultLocale, isLocale, locales } from "../lib/i18n";

test("i18n config defaults to German", () => {
  assert.equal(defaultLocale, "de");
  assert.deepEqual(locales, ["de", "en"]);
});

test("isLocale accepts de/en only", () => {
  assert.equal(isLocale("de"), true);
  assert.equal(isLocale("en"), true);
  assert.equal(isLocale("fr"), false);
});
```

**Step 2: Run test to verify it fails**

Run: `node --test tests/i18n.test.ts`
Expected: FAIL (module not found `lib/i18n`)

**Step 3: Write minimal implementation**

```ts
export const locales = ["de", "en"] as const;
export type Locale = (typeof locales)[number];
export const defaultLocale: Locale = "de";

export function isLocale(value: string): value is Locale {
  return locales.includes(value as Locale);
}
```

Update the portfolio layout to validate `params.locale` and set `<html lang>`:

```tsx
import { notFound } from "next/navigation";
import type { Locale } from "@/lib/i18n";
import { isLocale, locales } from "@/lib/i18n";

export async function generateStaticParams() {
  return locales.map((locale) => ({ locale }));
}

export default async function RootLayout({ children, params }: LayoutProps<"/[locale]">) {
  const { locale } = await params;
  if (!isLocale(locale)) notFound();
  return (
    <ClerkProvider>
      <html lang={locale} suppressHydrationWarning>
        <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
          {/* existing providers */}
        </body>
      </html>
    </ClerkProvider>
  );
}
```

Update the page signature:

```tsx
import type { Locale } from "@/lib/i18n";
import PortfolioContent from "@/components/PortfolioContent";

export default async function Home({ params }: PageProps<"/[locale]">) {
  const { locale } = await params;
  return (
    <main className="min-h-screen">
      <PortfolioContent locale={locale as Locale} />
    </main>
  );
}
```

**Step 4: Run test to verify it passes**

Run: `node --test tests/i18n.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add lib/i18n.ts app/(portfolio)/[locale]/layout.tsx app/(portfolio)/[locale]/page.tsx tests/i18n.test.ts
git commit -m "feat: add locale config and route segment"
```

---

### Task 2: Locale redirect + fallback flag in middleware

**Files:**
- Modify: `proxy.ts`
- Modify: `tests/middleware.test.ts`
- Add dependencies: `@formatjs/intl-localematcher`, `negotiator`

**Step 1: Write the failing tests**

```ts
test("proxy middleware redirects to German when locale is missing", async () => {
  const request = new NextRequest("http://localhost:3000/", {
    headers: { "accept-language": "fr-FR,fr;q=0.9" }
  });
  const response = await proxyMiddleware(request, {} as any);
  assert.equal(response?.headers.get("location")?.includes("/de"), true);
  assert.equal(response?.cookies.get("i18n-fallback")?.value, "1");
});

test("proxy middleware redirects when locale segment is unsupported", async () => {
  const request = new NextRequest("http://localhost:3000/fr/projects");
  const response = await proxyMiddleware(request, {} as any);
  assert.equal(response?.headers.get("location")?.includes("/de/projects"), true);
});
```

**Step 2: Run tests to verify they fail**

Run: `node --test tests/middleware.test.ts`
Expected: FAIL (no redirect behavior yet)

**Step 3: Write minimal implementation**

- Add locale utilities to `proxy.ts`:
  - Use `Accept-Language` to choose a locale, fallback to `defaultLocale` (`de`).
  - Parse first path segment; only treat it as a locale if `isLocale(segment)`.
  - If locale is missing or invalid, redirect to `/${locale}${pathnameWithoutBadLocale}`.
  - Set `i18n-fallback=1` cookie on redirect.
  - Skip `/studio` and static assets; preserve existing Clerk protection.

Pseudo-logic:

```ts
const localeFromPath = getFirstSegment(pathname);
const locale = isLocale(localeFromPath) ? localeFromPath : getLocaleFromHeaders(req);
if (!isLocale(localeFromPath)) {
  const pathWithoutLocale = stripFirstSegmentIfLooksLikeLocale(pathname);
  redirect(`/${locale}${pathWithoutLocale}`) + setCookie("i18n-fallback", "1");
}
```

**Step 4: Run tests to verify they pass**

Run: `node --test tests/middleware.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add proxy.ts tests/middleware.test.ts
git commit -m "feat: add locale redirect and fallback flag"
```

---

### Task 3: Install and configure document-level i18n in Sanity

**Files:**
- Modify: `sanity.config.ts`
- Create: `sanity/schemaTypes/locale.ts`
- Modify: `sanity/schemaTypes/*.ts` (add `language` field)
- Modify: `sanity/schemaTypes/index.ts`

**Step 1: Write failing type check**

Run: `pnpm lint`
Expected: FAIL after adding code with missing imports or types

**Step 2: Write minimal implementation**

Add a shared helper:

```ts
import { defineField } from "sanity";

export const languageField = () =>
  defineField({
    name: "language",
    type: "string",
    readOnly: true,
    hidden: true,
  });
```

Update `sanity.config.ts`:

```ts
import { documentInternationalization } from "@sanity/document-internationalization";

documentInternationalization({
  supportedLanguages: [
    { id: "de", title: "German" },
    { id: "en", title: "English" },
  ],
  schemaTypes: [
    "profile",
    "project",
    "service",
    "skillCategory",
    "skill",
    "experience",
    "education",
    "testimonial",
    "certification",
    "achievement",
    "blog",
    "navigation",
    "siteSettings",
  ],
});
```

Add `languageField()` as the first field in each localized schema listed above.

**Step 3: Run lint to verify it passes**

Run: `pnpm lint`
Expected: PASS

**Step 4: Commit**

```bash
git add sanity.config.ts sanity/schemaTypes/locale.ts sanity/schemaTypes/*.ts sanity/schemaTypes/index.ts
git commit -m "feat: enable Sanity document internationalization"
```

---

### Task 4: Localize singleton documents (Profile, Site Settings)

**Files:**
- Add: `scripts/sanity/create-singletons-i18n.ts`
- Modify: `sanity/structure.ts`
- Modify: queries that target `_id == "singleton-profile"`

**Step 1: Write failing test (script smoke check)**

Create a minimal node test verifying the script exports a `run` function:

```ts
import assert from "node:assert/strict";
import test from "node:test";
import { run } from "../scripts/sanity/create-singletons-i18n";

test("singleton creation script exports run", () => {
  assert.equal(typeof run, "function");
});
```

**Step 2: Run test to verify it fails**

Run: `node --test tests/sanity-singletons.test.ts`
Expected: FAIL (module not found)

**Step 3: Write minimal implementation**

Script outline:

```ts
import { createClient } from "@sanity/client";

const client = createClient({ projectId, dataset, apiVersion, token, useCdn: false });

const SINGLETONS = [
  { id: "profile", type: "profile" },
  { id: "siteSettings", type: "siteSettings" },
];
const LANGUAGES = ["de", "en"];

export async function run() {
  for (const singleton of SINGLETONS) {
    const ids = LANGUAGES.map((lang) => `${singleton.id}-${lang}`);
    // create docs if missing
    // create translation.metadata doc linking the IDs
  }
}

if (require.main === module) run();
```

Update `sanity/structure.ts` to show per-locale singleton docs (per plugin docs `01-singleton-documents.md`).

Update singleton queries to filter by `language == $language`:
- `components/sections/HeroSection.tsx`
- `components/sections/AboutSection.tsx`
- `components/sections/ContactSection.tsx`
- `components/chat/ChatWrapper.tsx`

**Step 4: Run test to verify it passes**

Run: `node --test tests/sanity-singletons.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add scripts/sanity/create-singletons-i18n.ts sanity/structure.ts components/sections/*.tsx components/chat/ChatWrapper.tsx tests/sanity-singletons.test.ts
git commit -m "feat: localize singleton documents"
```

---

### Task 5: Make all GROQ queries locale-aware

**Files:**
- Modify: `components/PortfolioContent.tsx`
- Modify: `components/sections/*.tsx`
- Modify: `components/FloatingDock.tsx`
- Modify: `components/app-sidebar.tsx`
- Regenerate: `sanity.types.ts`

**Step 1: Write the failing test**

Add a minimal test to ensure sections accept a locale prop:

```ts
import assert from "node:assert/strict";
import test from "node:test";
import { HeroSection } from "../components/sections/HeroSection";

test("HeroSection accepts locale prop", () => {
  assert.equal(typeof HeroSection, "function");
});
```

**Step 2: Run test to verify it fails**

Run: `node --test tests/i18n-components.test.ts`
Expected: FAIL after TypeScript check or when adjusting exports

**Step 3: Write minimal implementation**

Update `PortfolioContent` to accept `locale` and pass down:

```tsx
import type { Locale } from "@/lib/i18n";

type Props = { locale: Locale };

async function PortfolioContent({ locale }: Props) {
  return (
    <>
      <HeroSection locale={locale} />
      <AboutSection locale={locale} />
      <TestimonialsSection locale={locale} />
      <SkillsSection locale={locale} />
      <ExperienceSection locale={locale} />
      <EducationSection locale={locale} />
      <ProjectsSection locale={locale} />
      <CertificationsSection locale={locale} />
      <AchievementsSection locale={locale} />
      <ServicesSection locale={locale} />
      <BlogSection locale={locale} />
      <ContactSection locale={locale} />
    </>
  );
}
```

Update each section signature and query:

```ts
const QUERY = defineQuery(`*[_type == "project" && language == $language] | order(order asc){ ... }`);
const { data } = await sanityFetch({ query: QUERY, params: { language: locale } });
```

Update `FloatingDock` and `AppSidebar` to accept locale and ensure `href` uses locale for non-anchor paths.

**Step 4: Run tests to verify they pass**

Run: `pnpm lint`
Expected: PASS

**Step 5: Regenerate types**

Run: `pnpm typegen`
Expected: `sanity.types.ts` updated

**Step 6: Commit**

```bash
git add components/PortfolioContent.tsx components/sections/*.tsx components/FloatingDock.tsx components/app-sidebar.tsx sanity.types.ts tests/i18n-components.test.ts
git commit -m "feat: filter Sanity queries by locale"
```

---

### Task 6: Move UI copy into Sanity (no JSON strings)

**Files:**
- Create: `sanity/schemaTypes/uiCopy.ts`
- Modify: `sanity/schemaTypes/index.ts`
- Modify: section components to fetch copy per locale

**Step 1: Write the failing test**

```ts
import assert from "node:assert/strict";
import test from "node:test";
import uiCopy from "../sanity/schemaTypes/uiCopy";

test("uiCopy schema exports a document", () => {
  assert.equal(uiCopy.name, "uiCopy");
});
```

**Step 2: Run test to verify it fails**

Run: `node --test tests/ui-copy.test.ts`
Expected: FAIL (module not found)

**Step 3: Write minimal implementation**

```ts
import { defineField, defineType } from "sanity";
import { languageField } from "./locale";

export default defineType({
  name: "uiCopy",
  title: "UI Copy",
  type: "document",
  fields: [
    languageField(),
    defineField({ name: "section", type: "string" }),
    defineField({ name: "title", type: "string" }),
    defineField({ name: "subtitle", type: "text", rows: 2 }),
    defineField({ name: "ctaPrimary", type: "string" }),
    defineField({ name: "ctaSecondary", type: "string" }),
  ],
});
```

Update sections to query `uiCopy` for the section key and `language`. Use `coalesce` to fall back to `defaultLocale` if the translation is missing.

**Step 4: Run test to verify it passes**

Run: `node --test tests/ui-copy.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add sanity/schemaTypes/uiCopy.ts sanity/schemaTypes/index.ts components/sections/*.tsx tests/ui-copy.test.ts
git commit -m "feat: source UI copy from Sanity"
```

---

### Task 7: Add translate icon button and fallback banner

**Files:**
- Create: `components/LanguageSwitcher.tsx`
- Modify: `app/(portfolio)/[locale]/layout.tsx`

**Step 1: Write the failing test**

```ts
import assert from "node:assert/strict";
import test from "node:test";
import { buildLocalePath } from "../lib/i18n";

test("buildLocalePath swaps locale", () => {
  assert.equal(buildLocalePath("/de/projects", "en"), "/en/projects");
});
```

**Step 2: Run test to verify it fails**

Run: `node --test tests/locale-path.test.ts`
Expected: FAIL (helper not implemented)

**Step 3: Write minimal implementation**

Add helper to `lib/i18n.ts`:

```ts
export function buildLocalePath(pathname: string, locale: Locale) {
  const segments = pathname.split("/").filter(Boolean);
  if (segments.length > 0 && isLocale(segments[0])) {
    segments[0] = locale;
  } else {
    segments.unshift(locale);
  }
  return `/${segments.join("/")}`;
}
```

Create `LanguageSwitcher` (client component) that:
- Shows a clear "Translate" button with a languages icon.
- Switches locale using `buildLocalePath` and sets `NEXT_LOCALE` cookie.

Update layout to:
- Read `i18n-fallback` cookie.
- Render a compact banner when present.
- Place translate button near the theme toggle and in the banner.

**Step 4: Run test to verify it passes**

Run: `node --test tests/locale-path.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add components/LanguageSwitcher.tsx app/(portfolio)/[locale]/layout.tsx lib/i18n.ts tests/locale-path.test.ts
git commit -m "feat: add translate button and fallback banner"
```

---

### Task 8: Locale-aware metadata and SEO alternates

**Files:**
- Modify: `app/(portfolio)/[locale]/layout.tsx`
- Modify: queries for `siteSettings`

**Step 1: Write the failing test**

Add a metadata test stub (ensure `generateMetadata` exports):

```ts
import assert from "node:assert/strict";
import test from "node:test";
import * as layout from "../app/(portfolio)/[locale]/layout";

test("layout exports generateMetadata", () => {
  assert.equal(typeof layout.generateMetadata, "function");
});
```

**Step 2: Run test to verify it fails**

Run: `node --test tests/metadata.test.ts`
Expected: FAIL (function not exported)

**Step 3: Write minimal implementation**

- Add `generateMetadata` to fetch `siteSettings` by `language`.
- Include `alternates.languages` for `de` and `en` using `buildLocalePath`.

**Step 4: Run test to verify it passes**

Run: `node --test tests/metadata.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add app/(portfolio)/[locale]/layout.tsx tests/metadata.test.ts
git commit -m "feat: add locale-aware metadata"
```

---

### Task 9: Final verification

**Run:**
- `pnpm lint`
- `node --test tests/middleware.test.ts`
- `pnpm typegen`
- `pnpm build` (optional)

**Expected:** all pass.
