name: Deploy and Promote Domain

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Vercel token
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸ” Validating VERCEL_TOKEN..."
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "ERROR: VERCEL_TOKEN is not set (check repository secrets)" >&2
            exit 1
          fi
          # will print who the token belongs to or exit non-zero if invalid
          npx vercel whoami --token "$VERCEL_TOKEN"

      - name: Validate NEXT_PUBLIC_SANITY_DATASET
        env:
          NEXT_PUBLIC_SANITY_DATASET: ${{ vars.NEXT_PUBLIC_SANITY_DATASET }}
        run: |
          echo "ðŸ›  Validating NEXT_PUBLIC_SANITY_DATASET availability..."
          if [ -z "${NEXT_PUBLIC_SANITY_DATASET+x}" ]; then
            echo "::error::NEXT_PUBLIC_SANITY_DATASET is UNSET (no repository secret found)."
            exit 1
          fi
          if [ -z "$NEXT_PUBLIC_SANITY_DATASET" ]; then
            echo "::error::NEXT_PUBLIC_SANITY_DATASET is defined but EMPTY."
            exit 1
          fi
          echo "::notice::NEXT_PUBLIC_SANITY_DATASET is set (value: ${NEXT_PUBLIC_SANITY_DATASET})."

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ vars.NEXT_PUBLIC_SANITY_DATASET }}
        run: |
          echo "ðŸš€ Deploying to Vercel (non-interactive)..."
          npx vercel --token "$VERCEL_TOKEN" --prod --yes --env NEXT_PUBLIC_SANITY_DATASET="$NEXT_PUBLIC_SANITY_DATASET"

      - name: Promote production domain
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸ“¢ Promoting shivansh-sharma.vercel.app as production..."
          npx vercel promote --token "$VERCEL_TOKEN" --target production https://shivansh-portfolio-l503zdxis-shivansh-sharmas-projects-e8c05f0b.vercel.app --confirm
          echo "âœ… Production promotion complete"

    permissions:
      contents: read
      id-token: write
