name: Deploy and Promote Domain

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Vercel token
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸ” Validating VERCEL_TOKEN..."
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "ERROR: VERCEL_TOKEN is not set (check repository secrets)" >&2
            exit 1
          fi
          # will print who the token belongs to or exit non-zero if invalid
          npx vercel whoami --token "$VERCEL_TOKEN"

      - name: Validate NEXT_PUBLIC_SANITY_DATASET
        env:
          NEXT_PUBLIC_SANITY_DATASET: ${{ vars.NEXT_PUBLIC_SANITY_DATASET }}
        run: |
          echo "ðŸ›  Validating NEXT_PUBLIC_SANITY_DATASET availability..."
          if [ -z "${NEXT_PUBLIC_SANITY_DATASET+x}" ]; then
            echo "::error::NEXT_PUBLIC_SANITY_DATASET is UNSET (no repository variable found)."
            exit 1
          fi
          if [ -z "$NEXT_PUBLIC_SANITY_DATASET" ]; then
            echo "::error::NEXT_PUBLIC_SANITY_DATASET is defined but EMPTY."
            exit 1
          fi
          echo "::notice::NEXT_PUBLIC_SANITY_DATASET is set (value: ${NEXT_PUBLIC_SANITY_DATASET})."

      - name: Validate Vercel project configuration
        env:
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
          VERCEL_PROJECT_NAME: ${{ vars.VERCEL_PROJECT_NAME }}
        run: |
          echo "ðŸ§­ Validating Vercel project configuration..."
          if [ -z "${VERCEL_ORG_ID+x}" ] || [ -z "$VERCEL_ORG_ID" ]; then
            echo "::error::VERCEL_ORG_ID is missing. Set repository variable VERCEL_ORG_ID." >&2
            exit 1
          fi
          if [ -z "${VERCEL_PROJECT_ID+x}" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "::error::VERCEL_PROJECT_ID is missing. Set repository variable VERCEL_PROJECT_ID." >&2
            exit 1
          fi
          if [ -z "${VERCEL_PROJECT_NAME+x}" ] || [ -z "$VERCEL_PROJECT_NAME" ]; then
            echo "::error::VERCEL_PROJECT_NAME is missing. Set repository variable VERCEL_PROJECT_NAME." >&2
            exit 1
          fi
          echo "::notice::Vercel project config OK (org: ${VERCEL_ORG_ID}, project: ${VERCEL_PROJECT_NAME})."

      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ vars.NEXT_PUBLIC_SANITY_DATASET }}
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
          VERCEL_PROJECT_NAME: ${{ vars.VERCEL_PROJECT_NAME }}
        run: |
          echo "ðŸš€ Deploying to Vercel (non-interactive)..."
          # Use both VERCEL_ORG_ID and VERCEL_PROJECT_ID to ensure correct project
          VERCEL_ORG_ID="${VERCEL_ORG_ID}"
          VERCEL_PROJECT_ID="${VERCEL_PROJECT_ID}"
          VERCEL_PROJECT_NAME="${VERCEL_PROJECT_NAME}"
          export VERCEL_ORG_ID VERCEL_PROJECT_ID VERCEL_PROJECT_NAME

          # Link explicitly to the correct project/scope to avoid accidental fallback
          npx vercel link --yes --project "$VERCEL_PROJECT_NAME" --scope "$VERCEL_ORG_ID" --token "$VERCEL_TOKEN"

          # Pull production environment variables to avoid dev/preview drift
          npx vercel pull --yes --environment=production --scope "$VERCEL_ORG_ID" --token "$VERCEL_TOKEN"

          # Deploy explicitly to the intended project/scope
          DEPLOY_OUTPUT=$(npx vercel deploy --prod --yes --scope "$VERCEL_ORG_ID" --project "$VERCEL_PROJECT_NAME" --token "$VERCEL_TOKEN" --env NEXT_PUBLIC_SANITY_DATASET="$NEXT_PUBLIC_SANITY_DATASET" --env SANITY_STUDIO_DATASET="$NEXT_PUBLIC_SANITY_DATASET")
          VERCEL_STATUS=$?
          if [ "$VERCEL_STATUS" -ne 0 ]; then
            echo -e "::error::Vercel deploy failed with exit code $VERCEL_STATUS. Output:\n$DEPLOY_OUTPUT" >&2
            exit "$VERCEL_STATUS"
          fi
          echo "$DEPLOY_OUTPUT"

          # Extract deployment URL from Vercel output
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE "https://${VERCEL_PROJECT_NAME}-[^[:space:]]+\.vercel\.app" | head -1)

          # Fallback: extract any Vercel deployment URL if the pattern doesn't match
          if [ -z "$DEPLOY_URL" ]; then
            DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE 'https://[^[:space:]]+\.vercel\.app' | grep -E "${VERCEL_PROJECT_NAME}" | head -1)
          fi
          
          if [ -z "$DEPLOY_URL" ]; then
            echo "::error::Could not extract deployment URL from Vercel output"
            exit 1
          fi
          
          echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment URL captured: $DEPLOY_URL"

      - name: Verify production deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "âœ… Deployment already promoted to production via --prod flag"
          echo "ðŸ”— Production URL: https://shivansh-sharma.vercel.app"
          echo "ðŸ“Š Deployment URL: ${{ steps.deploy.outputs.deployment_url }}"

    permissions:
      contents: read
      id-token: write
